/**
 * \brief JS script admin for chat
 *
 * Main dependency: node.js 
 *
 * \date 05/11/2012
 * \autor Macroplus
 */

var numClients=0;var socket;var h="-1";var m="-1";var s="-1";var setBlock=false;var user_selected;var user_closed=false;function getCurrentTime(d){var b=new Date();var a=b.getHours()<10?"0"+b.getHours():b.getHours();var c=b.getMinutes()<10?"0"+b.getMinutes():b.getMinutes();var e=b.getSeconds()<10?"0"+b.getSeconds():b.getSeconds();if(h===a&&m===c&&s===e&&d==="from"){setBlock=true}h=a;m=c;s=e;return a+":"+c+":"+e}function unblock(){setBlock=false;$("#message").attr("placeholder","Escribe un mensaje y presiona Enter...");$("#message").attr("title","Escribe un mensaje y presiona Enter...");$("#message").removeAttr("disabled");$("#message").focus()}function getHTML(a){return document.getElementById(a).innerHTML}function selectThis(b,d,a){if(user_closed){user_closed=false;return}$("#hidden_current_client").val(b);$("#hidden_current_nick_client").val(d);$("#hidden_current_loginame").val(a);$("tr","#current_clients").removeClass("selected");$("#"+a).addClass("selected");$("."+a).addClass("hidden");$("#"+a+"_notif").text("0");user_selected=$("#"+a+"_historial");var c=$("#log");c.empty().append($("#"+a+"_historial").html());c.scrollTop(c[0].scrollHeight);if(!$("."+a+"_i").hasClass("icon-remove-sign")){$("#normal_sending").removeClass("disabled");$("#broadcast_sending").removeClass("disabled");$("#message").removeAttr("disabled");$("#message").focus()}else{$("#normal_sending").addClass("disabled");$("#broadcast_sending").addClass("disabled");$("#message").attr("disabled","true")}}function see_historial(a){window.open("check_historial.php?nro_iden_user="+a+"&nro_iden_adm="+$("#hidden_tipo_identificacion").val()+$("#hidden_nro_identificacion").val()+"&servicio="+$("#hidden_servicio").val(),"","directories=0, menubar=0, status=0, toolbar=0, location=0, resizable=0, scrollbars=0, fullscreen=0, height=600, width=600")}function close_conv(a,c,b){user_closed=true;socket.emit("messageSimplex",{to:a,admin:1,message:$(".nickname-display").text()+" se ha desconectado. Si requiere de nuevo el servicio, por favor cierre esta ventana e intente conectar de nuevo."});$("#normal_sending").addClass("disabled");$("#broadcast_sending").addClass("disabled");$("#message").attr("disabled","true");$("#"+c).remove();$("#"+c+"_historial").remove();$("#log").empty();numClients--;socket.emit("numclients",{nroiden:$("#hidden_tipo_identificacion").val()+$("#hidden_nro_identificacion").val(),operacion:"res"});if(numClients<10){$("#clients_div").removeClass("scrollable")}}$(document).ready(function(){try{socket=io.connect("http://www.subastafiscal.com",{port:3000,rememberTransport:false,connectTimeout:10000});var c=Backbone.View.extend({el:"#login",nickname:"",asesoria:"",events:{"click .btn.login":"login","click .btn.logout":"logout"},initialize:function(){_.bindAll(this);socket.on("login ok",this.loginOk);socket.on("login error",this.loginError);socket.on("logout ok",this.logoutOk)},login:function(){this.nickname=this.$("#nickname").val();this.asesoria=this.$("#type_asesor option:selected").text();socket.emit("login attempt admin",{nickname:this.nickname,asesoria:$("#type_asesor").val()});return false},loginOk:function(f){this.$(".login-form").hide();this.$(".logout-form").show();this.$("#hidden_username").val(f.name_user);$("#hidden_from").val(f.id);this.$(".nickname-display").text(f.name_user);$("#information_service").html("Ud está ofreciendo el servicio de <strong>"+this.asesoria+"</strong>.")},loginError:function(f){alert(f.message)},logout:function(){socket.emit("logout attempt admin",{nickname:$(".nickname-display").text(),num_msg:1});return false},logoutOk:function(f){$(".logout-form").hide();$(".login-form").show()}});var e=Backbone.View.extend({el:"#chat_div",scroll:0,events:{"keyup #message":"send","click #normal_sending":"send_click","click #broadcast_sending":"send_broadcast","click #exit_chat":"logout"},initialize:function(){_.bindAll(this);socket.on("login ok",this.loginOk);socket.on("logout ok",this.logoutOk);socket.on("message",this.message);socket.on("message_server",this.message_server);socket.on("message_bc",this.message_bc);socket.on("message_welcome",this.message_welcome)},general_send:function(j){var t=$("#message").val();var o=$("#hidden_from").val();var k=$(".nickname-display").text();var p=$("#hidden_current_client").val();var q=$("#hidden_current_nick_client").val();var g=$("#hidden_current_loginame").val();var l=/(\<(\/?[^\>]+)\>)/gm;var r=/<script.+?src=\"(.+?\.js(?:\?v=\d)*).+?script>/ig;var n=/<link.+?href=\"(.+?\.css(?:\?v=\d)*).+?>/ig;var f=false;if(t.toLowerCase().match(r)){f=true}else{if(t.toLowerCase().match(l)){f=true}else{if(t.toLowerCase().match(n)){f=true}}}var i={message:t,nickname:k,to:p,nickto:q,from:o,badcode:f};if(!j){socket.emit("message",{message:t,nickname:k,loginame:g,to:p,nickto:q,from:o,badcode:f})}else{socket.emit("message_broadcast",{message:t,nickname:k,from:o,badcode:f})}$("#message").val("");$("#message").focus()},send:function(f){if(f.keyCode===13){if($.trim($("#message").val())===""){return}this.general_send(false)}},send_click:function(){if($.trim($("#message").val())===""){return}this.general_send(false)},send_broadcast:function(){if($.trim($("#message").val())===""){return}this.general_send(true)},loginOk:function(){this.$el.show()},logout:function(){socket.emit("logout attempt admin",{nickname:$(".nickname-display").text(),loginame:$(".nickname-display").text(),nroiden:$("#hidden_tipo_identificacion").val()+$("#hidden_nro_identificacion").val(),num_msg:1});return false},logoutOk:function(){$("#log").empty();$("#historial").empty();window.location.href="index.php"},message:function(j){var g=getCurrentTime(j.who);if(setBlock){$("#message").attr("disabled","true").attr("placeholder","Espere que se habilite nuevamente...");$("#message").attr("title","Espere que se habilite nuevamente...");setTimeout("unblock()",3000);alert("Estás escribiendo muy rápido, ¿seguro que eres humano?")}var p=j.who==="from"?"":"unicast";var i=this.$("#log"),l=$('<div class="span5 nickname '+p+'"></div>'),t=$('<div class="span5 '+p+'"></div>'),r=$('<div class="row"></div>');var k="";var q=false;if(j.who==="from"){k=j.nickname}else{k=j.nickname2;try{getHTML(j.loginame)}catch(n){q=true;numClients++;socket.emit("numclients",{nroiden:$("#hidden_tipo_identificacion").val()+$("#hidden_nro_identificacion").val(),operacion:"sum"});if(numClients>9){$("#clients_div").addClass("scrollable")}}if(q){$("#_kHFhtdcvfC767fghFGH").append($("<input>").attr("id",j.loginame+"_Gbhhyf87ghjfJF5").attr("type","hidden").attr("value",j.from));$("#current_clients").find("tbody").append($("<tr>").attr("id",j.loginame).attr("onclick",'selectThis("'+j.from+'","'+j.nickname2+'","'+j.loginame+'");').append($("<td>").append($("<i>").attr("class","icon-ok-sign "+j.loginame+"_i").attr("title","Conectado"))).append($("<td>").append($("<label>").text(j.nickname2))).append($("<td>").append($("<div>").attr("class","notification "+j.loginame).append($("<span>").attr("id",j.loginame+"_notif").attr("class","badge badge-info").text("0")))).append($("<td>").append($("<a>").attr("src","#").attr("onclick",'see_historial("'+j.nroiden+'");').attr("class","close_conv").append($("<i>").attr("class","icon-time").attr("title","Ver historial de conversaciones")))).append($("<td>").append($("<a>").attr("src","#").attr("onclick",'close_conv("'+j.from+'","'+j.loginame+'", "'+j.nroiden+'");').attr("class","close_conv").append($("<i>").attr("class","icon-remove").attr("title","Cerrar conversación"))).append($("<input>").attr("id",j.loginame+"_scroll").attr("type","hidden")).append($("<input>").attr("id",j.loginame+"_conv").attr("type","hidden").attr("value",j.from))));$("#historial").append($("<div>").attr("id",j.loginame+"_historial").attr("class","incoming"))}}l.text(k+" ("+g+")");if(!j.badcode){t.append(j.message)}else{t.text(j.message)}r.append(l).append(t);$("#"+j.loginame+"_historial").append(r);if($("#"+j.loginame).hasClass("selected")){i.empty();i.append($("#"+j.loginame+"_historial").html());i.scrollTop(i[0].scrollHeight)}else{var o=Number($("#"+j.loginame+"_notif").text());o++;var f=o>9?"+"+9:o;$("#"+j.loginame+"_notif").html("<i class='icon-envelope icon-white'></i> "+f);$("."+j.loginame).removeClass("hidden")}if(q){$.ajax({type:"POST",url:"save_historial_sb_sf.php",data:encodeURI("nroiden_user="+j.nroiden+"&nroiden_asesor="+$("#hidden_tipo_identificacion").val()+$("#hidden_nro_identificacion").val()+"&conversacion="+$("#"+j.loginame+"_historial").html()+"&servicio="+$("#hidden_servicio").val()+"&idconv="+$("#"+j.loginame+"_conv").val()),datatype:"html",async:true,statusCode:{404:function(){}},success:function(u){if(u=="success"){}}})}else{$.ajax({type:"POST",url:"update_historial_sb_sf.php",data:encodeURI("mensaje="+r.html()+"&idconv="+$("#"+j.loginame+"_conv").val()),datatype:"html",async:true,statusCode:{404:function(){}},success:function(u){if(u=="success"){}}})}},message_server:function(k){var l=getCurrentTime("server");var i=this.$("#log"),f=$('<div class="span5 nickname server"></div>'),j=$('<div class="span5 server"></div>'),n=$('<div class="row"></div>');f.text(k.nickname+" ("+l+")");j.text(k.message);n.append(f).append(j);$("#"+k.who+"_historial").append(n);if($("#"+k.who).hasClass("selected")){$("#normal_sending").addClass("disabled");$("#broadcast_sending").addClass("disabled");$("#message").attr("disabled","true");i.empty();i.append($("#"+k.who+"_historial").html());i.scrollTop(i[0].scrollHeight)}else{var g=Number($("#"+k.who+"_notif").text());g++;var o=g>9?"+"+9:g;$("#"+k.who+"_notif").html("<i class='icon-envelope icon-white'></i> "+o);$("."+k.who).removeClass("hidden")}$("."+k.who+"_i").removeClass("icon-ok-sign");$("."+k.who+"_i").addClass("icon-remove-sign");$("."+k.who+"_i").attr("title","Desconectado")},message_bc:function(j){var k=getCurrentTime("to");var g=$("#log"),f=$('<div class="span5 nickname broadcast"></div>'),i=$('<div class="span5 broadcast"></div>'),l=$('<div class="row"></div>');f.text(j.nickname+" ("+k+")");i.text(j.message);l.append(f).append(i);$(".incoming").append(l);g.empty();g.append(user_selected.html());g.scrollTop(g[0].scrollHeight)},message_welcome:function(k){var l=getCurrentTime("to");var g=this.$("#log"),f=$('<div class="span5 nickname server"></div>'),i=$('<div class="span5 server"></div>'),n=$('<div class="row"></div>');f.text(k.nickname+" ("+l+")");i.text(k.message);n.append(f).append(i);g.append(n);g.scrollTop(g[0].scrollHeight);var j=$("#service option:selected").text();$("#hidden_servicio").val($("#service").val());$("#information_service").html("<span>Ud está ofreciendo el servicio de <strong>"+j+"</strong></span>.");$("#sel_service").fadeOut("fast");$("#chat_div").fadeIn("fast")}});var b=new c();var a=new e();$("#sel_service_btn").click(function(){socket.emit("login attempt admin",{nombre:$(".nickname-display").text(),cookie:socket.id,tipo_identificacion:$("#hidden_tipo_identificacion").val(),nro_identificacion:$("#hidden_nro_identificacion").val(),asesoria:$("#service").val(),correo:$("#hidden_correo").val()})})}catch(d){document.location.href="error.php"}});