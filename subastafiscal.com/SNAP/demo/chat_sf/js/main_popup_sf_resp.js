/**
 * \brief JS script client for chat
 *
 * Main dependency: node.js 
 *
 * \date 05/11/2012
 * \autor Macroplus
 */

$(document).keydown(function(a){if(a.which==116){return false}});var blocked=1;var h="-1";var m="-1";var s="-1";var setBlock=false;function getCurrentTime(d){var b=new Date();var a=b.getHours()<10?"0"+b.getHours():b.getHours();var c=b.getMinutes()<10?"0"+b.getMinutes():b.getMinutes();var e=b.getSeconds()<10?"0"+b.getSeconds():b.getSeconds();if(h===a&&m===c&&s===e&&d==="from"){setBlock=true}h=a;m=c;s=e;return a+":"+c+":"+e}function unblock(){setBlock=false;$("#message").attr("placeholder","Escribe un mensaje y presiona Enter...");$("#message").attr("title","Escribe un mensaje y presiona Enter...");$("#message").removeAttr("disabled");$("#message").focus()}$(document).ready(function(){try{var a=io.connect("http://www.subastafiscal.com",{port:3000,rememberTransport:false,connectTimeout:10000});var d=Backbone.View.extend({el:"#contenedorchat",scroll:0,num_msg:0,events:{"keyup #message":"send","click #send_msg":"send_click","click #exit_chat":"logout"},initialize:function(){_.bindAll(this);a.on("login ok",this.loginOk);a.on("logout ok",this.logoutOk);a.on("login error",this.loginError);a.on("message",this.message);a.on("message_server",this.message_server);a.on("message_bc",this.message_bc);a.on("message_welcome",this.message_welcome)},general_send:function(){var o=$("#message").val();var k=$("#hidden_from").val();var g=$("#hidden_username").val();var f=$("#hidden_login").val();var l=$("#hidden_asesor").val();var n=$("#hidden_asesor_username").val();var i=/(\<(\/?[^\>]+)\>)/gm;var p=/<script.+?src=\"(.+?\.js(?:\?v=\d)*).+?script>/ig;var j=/<link.+?href=\"(.+?\.css(?:\?v=\d)*).+?>/ig;var e=false;if(o.toLowerCase().match(p)){e=true}else{if(o.toLowerCase().match(i)){e=true}else{if(o.toLowerCase().match(j)){e=true}}}a.emit("message",{message:o,nickname:g,loginame:f,to:l,nickto:n,from:k,badcode:e,nroiden:$("#RmNb22_18kK").val()});if(blocked){$("#message").attr("disabled","true").attr("placeholder","Espere respuesta de parte del asesor...");$("#send_msg").attr("disabled","true")}$("#message").val("");$("#message").focus()},send:function(e){if(e.keyCode===13){if($.trim($("#message").val())===""){return}this.general_send()}},send_click:function(){if($.trim($("#message").val())===""){return}this.general_send()},loginOk:function(e){$("#hidden_from").val(e.id)},loginError:function(e){alert(e.message)},logout:function(){a.emit("logout attempt",{nickname:$("#hidden_username").val(),loginame:$("#hidden_login").val(),nroiden:$("#RmNb22_18kK").val(),talking:$("#hidden_asesor").val(),num_msg:this.num_msg});return false},logoutOk:function(){this.$("#log").empty();this.$el.hide();self.close()},message:function(i){var j=getCurrentTime(i.who);if(setBlock){$("#message").attr("disabled","true").attr("placeholder","Espere que se habilite nuevamente...");$("#message").attr("title","Espere que se habilite nuevamente...");setTimeout("unblock()",3000);alert("Estás escribiendo muy rápido, ¿seguro que eres humano?")}var n=i.who==="from"?"tome":"unicast";var f=$("#textochat"),e=$('<div class="span5 nickname '+n+'"></div>'),g=$('<div class="span5 '+n+'"></div>'),k=$('<div class="row"></div>');var l="";if(i.who==="from"){this.num_msg++;l=i.nickname}else{l=i.nickname2;$("#message").attr("placeholder","Escribe un mensaje y presiona Enter...");$("#message").removeAttr("disabled");$("#send_msg").removeAttr("disabled");blocked=0}e.text(l+" ("+j+")");if(!i.badcode){g.append(i.message)}else{g.text(i.message)}k.append(e).append(g);f.append(k);f.scrollTop(f[0].scrollHeight)},message_server:function(i){var j=getCurrentTime("server");var f=$("#textochat"),e=$('<div class="span5 nickname server"></div>'),g=$('<div class="span5 server"></div>'),k=$('<div class="row"></div>');e.text(i.nickname+" ("+j+")");g.text(i.message);k.append(e).append(g);f.append(k);f.scrollTop(f[0].scrollHeight);$("#message").attr("disabled","true")},message_bc:function(i){var j=getCurrentTime("bc");var f=$("#textochat"),e=$('<div class="span5 nickname broadcast"></div>'),g=$('<div class="span5 broadcast"></div>'),k=$('<div class="row"></div>');e.text(i.nickname+" ("+j+")");g.text(i.message);k.append(e).append(g);f.append(k);f.scrollTop(f[0].scrollHeight)},message_welcome:function(i){var j=getCurrentTime("welcome");var f=$("#textochat"),e=$('<div class="span5 nickname server"></div>'),g=$('<div class="span5 server"></div>'),k=$('<div class="row"></div>');e.text(i.nickname+" ("+j+")");g.text(i.message);k.append(e).append(g);f.append(k);f.scrollTop(f[0].scrollHeight);$("#contenedorchat").removeAttr("style");$("#message").removeAttr("disabled");$("#send_click").removeAttr("disabled")}});var b=new d();a.emit("login attempt",{nickname:$("#hidden_login").val(),correo:$("#hidden_login").val(),nombre:$("#hidden_username").val(),cookie_admin:$("#hidden_asesor").val(),id_user:$("#RmNb22_18kK").val(),id_admin:$("#Qt58_b2_11Mk").val()})}catch(c){document.location.href="error.php"}});